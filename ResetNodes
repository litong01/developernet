# -*- mode: ruby -*-
# vi: set ft=ruby :

require 'yaml'

nodes = YAML.load_file("provisioning/nodes.conf.yml")
ids = YAML.load_file("provisioning/ids.conf.yml")

Vagrant.configure("2") do |config|
  config.vm.box = "tknerr/managed-server-dummy"
  config.ssh.username = ids['username']
  config.ssh.password = ids['password']

  config.vm.synced_folder ".", "/vagrant", disabled: true
  config.vm.synced_folder "onvm", "/onvm", disabled: false, create: true

  nodes.each do |key, value|
    if ['keystone', 'cinder', 'horizon', 'heat'].include?(key) == false then
      config.vm.define "#{key}" do |node|
        node.vm.provider :managed do |managed|
          managed.server = nodes[key]['eth0']
        end

        node.vm.provision "reset", type: "shell" do |s|
          s.path = "onvm/scripts/reset/reset-node.sh"
          s.args = nodes[key]['eth1']
        end

        node.vm.provision "install-common", type: "shell" do |s|
          s.path = "onvm/scripts/reset/install-common.sh"
        end
      end
    end
  end

end
